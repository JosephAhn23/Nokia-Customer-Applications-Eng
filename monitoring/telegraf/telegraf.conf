# Telegraf Configuration for Network Monitoring
# Collects metrics from various sources and sends to InfluxDB

[agent]
  interval = "10s"
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  collection_jitter = "0s"
  flush_interval = "10s"
  flush_jitter = "0s"
  precision = ""
  hostname = "$HOSTNAME"
  omit_hostname = false

# OUTPUT: InfluxDB
[[outputs.influxdb]]
  urls = ["http://localhost:8086"]
  database = "netmon"
  retention_policy = ""
  username = "$INFLUXDB_USER"
  password = "$INFLUXDB_PASSWORD"
  user_agent = "telegraf"
  timeout = "5s"

# INPUT: Network Response Time
[[inputs.net_response]]
  protocol = "tcp"
  address = ":443"
  timeout = "5s"
  read_timeout = "5s"
  [inputs.net_response.tags]
    service = "https"

[[inputs.net_response]]
  protocol = "tcp"
  address = ":22"
  timeout = "5s"
  read_timeout = "5s"
  [inputs.net_response.tags]
    service = "ssh"

# INPUT: Ping
[[inputs.ping]]
  urls = ["8.8.8.8", "1.1.1.1"]
  count = 10
  ping_interval = 1.0
  timeout = 2.0
  [inputs.ping.tags]
    type = "external"

[[inputs.ping]]
  urls = ["192.168.1.1"]
  count = 5
  ping_interval = 1.0
  timeout = 2.0
  [inputs.ping.tags]
    type = "internal"

# INPUT: SNMP (if available)
[[inputs.snmp]]
  agents = ["udp://192.168.1.1:161"]
  version = 3
  sec_name = "monitoring"
  auth_protocol = "SHA"
  auth_password = "$SNMP_AUTH_PASS"
  priv_protocol = "AES"
  priv_password = "$SNMP_PRIV_PASS"
  
  [[inputs.snmp.field]]
    oid = "IF-MIB::ifInOctets"
    name = "bytes_in"
  
  [[inputs.snmp.field]]
    oid = "IF-MIB::ifOutOctets"
    name = "bytes_out"
  
  [[inputs.snmp.field]]
    oid = "IF-MIB::ifInErrors"
    name = "errors_in"
  
  [[inputs.snmp.field]]
    oid = "IF-MIB::ifOutErrors"
    name = "errors_out"

# INPUT: Prometheus (scrape our own metrics)
[[inputs.prometheus]]
  urls = ["http://localhost:9090/metrics"]
  metric_version = 2

# INPUT: System metrics
[[inputs.cpu]]
  percpu = true
  totalcpu = true
  collect_cpu_time = false
  report_active = false

[[inputs.disk]]
  ignore_fs = ["tmpfs", "devtmpfs", "devfs", "iso9660", "overlay", "aufs", "squashfs"]

[[inputs.diskio]]

[[inputs.mem]]

[[inputs.net]]

[[inputs.processes]]

[[inputs.swap]]

[[inputs.system]]

# INPUT: Custom metrics collector
[[inputs.exec]]
  commands = ["/opt/netmon/venv/bin/python /opt/netmon/metrics/custom_collector.py"]
  timeout = "10s"
  data_format = "influx"
  interval = "30s"
  [inputs.exec.tags]
    source = "custom_collector"

# INPUT: Docker (if containers are used)
[[inputs.docker]]
  endpoint = "unix:///var/run/docker.sock"
  container_names = []
  timeout = "5s"
  perdevice = true
  total = false

# INPUT: PostgreSQL
[[inputs.postgresql]]
  address = "postgres://netmon:${NETMON_DB_PASSWORD}@localhost:5432/netmon?sslmode=disable"
  databases = ["netmon"]
  
  # Query database metrics
  [[inputs.postgresql.query]]
    sqlquery = "SELECT COUNT(*) as device_count FROM devices"
    withdbname = false
    tagvalue = "device_count"
  
  [[inputs.postgresql.query]]
    sqlquery = "SELECT COUNT(*) as active_anomalies FROM anomalies WHERE resolved_at IS NULL"
    withdbname = false
    tagvalue = "active_anomalies"


